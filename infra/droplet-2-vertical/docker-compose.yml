# Droplet 2 - Construction Vertical
# Contains: FastAPI application for construction vertical
#
# Deploy order: Deploy AFTER Droplet 3 (needs PostgreSQL and Redis)

services:
  construction:
    build:
      context: ../../../
      dockerfile: apps/verticals/construction/Dockerfile
    container_name: basecommerce-construction
    restart: unless-stopped
    environment:
      # Database (connect to Droplet 3)
      DATABASE_URL: postgresql://${POSTGRES_USER:-basecommerce}:${POSTGRES_PASSWORD}@${INFRA_HOST}:5432/${POSTGRES_DB:-basecommerce}
      
      # Redis (connect to Droplet 3)
      REDIS_URL: redis://${INFRA_HOST}:6379/0
      
      # Application settings
      SECRET_KEY: ${SECRET_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: ${DEBUG:-false}
      
      # Gunicorn settings
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-2}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-1}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-60}
      
      # SQLAlchemy pool settings (conservative for 1GB)
      SQLALCHEMY_POOL_SIZE: ${SQLALCHEMY_POOL_SIZE:-5}
      SQLALCHEMY_MAX_OVERFLOW: ${SQLALCHEMY_MAX_OVERFLOW:-10}
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
    ports:
      - "${APP_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 256M
    networks:
      - vertical-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  vertical-network:
    driver: bridge

